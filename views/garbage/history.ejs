<% layout("layouts/biolerplate") %>

<head>
  <!-- Mapbox CSS -->
  <link href='https://api.mapbox.com/mapbox-gl-js/v2.20.0/mapbox-gl.css' rel='stylesheet' />
  <!-- Mapbox JS -->
  <script src='https://api.mapbox.com/mapbox-gl-js/v2.20.0/mapbox-gl.js'></script>
  <style>
    .map-container {
      width: 100%;
      height: 0;
      overflow: hidden;
      border-radius: 10px;
      opacity: 0;
      transition: all 0.5s ease;
      margin-bottom: 10px;
    }

    .map-container.show {
      height: 200px;
      min-height: 200px;
      opacity: 1;
    }

    .hover-shadow:hover {
      box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.15);
      transition: 0.3s ease;
    }
  </style>
</head>

<body class="bg-light">
  <div class="container py-5">
    <h2 class="mb-4 text-center text-primary">All Complaints</h2>

    <div class="row">
      <% if (Garbages && Garbages.length > 0) { %>
        <% Garbages.forEach(gar => { %>
          <div class="col-md-4 mb-4">
            <%
               const isOwner = currentUser && gar.user && String(gar.user._id) === String(currentUser._id);
               const isAssignedEmployee = currentEmployee && gar.assignedTo && String(gar.assignedTo._id) === String(currentEmployee._id);
               const isAdmin = currentUser && currentUser.role === "admin";
               const clickable = (isOwner || isAssignedEmployee) && gar.assignedTo;
            %>

            <% if (clickable) { %>
              <!-- Clickable card -->
              <a href="/complaints/<%= gar._id %>" class="text-decoration-none text-dark">
                <div class="card shadow-sm border-0 h-100 hover-shadow" style="min-height: 500px; cursor: pointer;">
                  <% if (gar.image) { %>
                    <img src="<%= gar.image %>" class="card-img-top" alt="Garbage Image" style="height: 200px; object-fit: cover;">
                  <% } else { %>
                    <img src="/images/placeholder.jpg" class="card-img-top" alt="No Image" style="height: 200px; object-fit: cover;">
                  <% } %>

                  <div class="card-body d-flex flex-column">
                    <h5 class="card-title text-capitalize"><%= gar.garbageType %></h5>
                    <p class="card-text flex-grow-1"><%= gar.description %></p>

                    <!-- Address with map toggle -->
                    <p class="card-text text-muted">
                      <i class="bi bi-geo-alt-fill" style="cursor:pointer; color:#007bff;"
                         onclick="toggleMap('<%= gar.address %>', '<%= gar._id %>')"></i>
                      <%= gar.address %>
                    </p>

                    <div id="map-<%= gar._id %>" class="map-container"></div>

                    <!-- Status -->
                    <span class="badge rounded-pill px-3 py-2 text-uppercase
                      <%= gar.status === 'done' ? 'bg-success' 
                        : gar.status === 'in-progress' ? 'bg-info text-dark' 
                        : 'bg-warning text-dark' %>">
                      <%= gar.status %>
                    </span>

                    <!-- Delete button -->
                    <% if (isOwner || isAdmin) { %>
                      <form action="/complaints/<%= gar._id %>?_method=DELETE" method="POST" class="mt-3">
                        <button type="submit" class="btn btn-sm btn-danger w-100">Delete</button>
                      </form>
                    <% } %>
                  </div>
                </div>
              </a>
            <% } else { %>
              <!-- Non-clickable card -->
              <div class="card shadow-sm border-0 h-100" style="min-height: 500px;">
                <% if (gar.image) { %>
                  <img src="<%= gar.image %>" class="card-img-top" alt="Garbage Image" style="height: 200px; object-fit: cover;">
                <% } else { %>
                  <img src="/images/placeholder.jpg" class="card-img-top" alt="No Image" style="height: 200px; object-fit: cover;">
                <% } %>

                <div class="card-body d-flex flex-column">
                  <h5 class="card-title text-capitalize"><%= gar.garbageType %></h5>
                  <p class="card-text flex-grow-1"><%= gar.description %></p>

                  <!-- Address with map toggle -->
                  <p class="card-text text-muted">
                    <i class="bi bi-geo-alt-fill" style="cursor:pointer; color:#007bff;"
                       onclick="toggleMap('<%= gar.address %>', '<%= gar._id %>')"></i>
                    <%= gar.address %>
                  </p>

                  <div id="map-<%= gar._id %>" class="map-container"></div>

                  <!-- Status -->
                  <span class="badge rounded-pill px-3 py-2 text-uppercase
                    <%= gar.status === 'done' ? 'bg-success' 
                      : gar.status === 'in-progress' ? 'bg-info text-dark' 
                      : 'bg-warning text-dark' %>">
                    <%= gar.status %>
                  </span>

                  <!-- Delete button -->
                  <% if (isOwner || isAdmin) { %>
                    <form action="/complaints/<%= gar._id %>?_method=DELETE" method="POST" class="mt-3">
                      <button type="submit" class="btn btn-sm btn-danger w-100">Delete</button>
                    </form>
                  <% } %>
                </div>
              </div>
            <% } %>
          </div>
        <% }) %>
      <% } else { %>
        <p class="text-center text-muted">No complaints found.</p>
      <% } %>
    </div>
  </div>

  <script>
    const maps = {};

    function toggleMap(address, id) {
      const mapDiv = document.getElementById("map-" + id);

      if (mapDiv.classList.contains("show")) {
        mapDiv.classList.remove("show");
        return;
      }

      // Hide other open maps
      document.querySelectorAll(".map-container.show").forEach(div => div.classList.remove("show"));

      mapDiv.classList.add("show");

      if (!maps[id]) {
        fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=<%= process.env.MAPBOX_TOKEN %>`)
          .then(res => res.json())
          .then(data => {
            if (data.features && data.features.length > 0) {
              const [lng, lat] = data.features[0].center;

              mapboxgl.accessToken = '<%= process.env.MAPBOX_TOKEN %>';
              const map = new mapboxgl.Map({
                container: mapDiv,
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [lng, lat],
                zoom: 14
              });

              new mapboxgl.Marker().setLngLat([lng, lat]).addTo(map);

              maps[id] = map;
            } else {
              alert("Location not found!");
              mapDiv.classList.remove("show");
            }
          })
          .catch(err => {
            console.error(err);
            alert("Error loading map!");
            mapDiv.classList.remove("show");
          });
      }
    }
  </script>
</body>
